<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Today - FocusFlow</title>
  <link rel="stylesheet" href="style.css" />

</head>
<body class="today-page">
  <div class="app-container">
    <div class="topbar"><strong>FocusFlow – Today 🏷️</strong></div>

    <div class="page-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav>
          <ul>
            <li><a href="homepage.html">Home 🏠</a></li>
            <li><a href="today.html" class="active">Today 🏷️</a></li>
            <li><a href="upcoming.html">Upcoming 🚀</a></li>
            <li><a href="calendar.html">Calendar 🗓️</a></li>
          </ul>
        </nav>
        <button onclick="logout()">Logout</button>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <div class="greeting" id="greetingText"></div>
          <div class="username-box" id="username"></div>
        </header>

        <!-- Feedback Messages -->
        <div id="message" class="message"></div>

        <!-- Today's Tasks -->
        <section class="task-list">
          <h3>Today's Tasks</h3>
          <p>View and manage your tasks for today.</p>
          
          <!-- Task Form -->
          <div class="task-form">
            <form id="taskForm">
              <input type="text" id="title" placeholder="What do you need to do?" required />
              <select id="priority">
                <option value="" disabled selected>Choose priority</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
              <textarea id="note" placeholder="Add a note..."></textarea>
              <button type="submit">Add Task</button>
            </form>
            <div id="formMessage"></div>
          </div>

          <!-- Task List -->
          <div id="todayTaskCards" class="task-cards"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000/tasks";
    const token = localStorage.getItem("token");
    const messageBox = document.getElementById("message");
    const todayTaskCards = document.getElementById("todayTaskCards");
    const usernameSpan = document.getElementById("username");
    const greetingText = document.getElementById("greetingText");

    // ✅ Logout
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    // ✅ Auth check + Greeting
    async function checkAuth() {
      if (!token) {
        window.location.href = "login.html";
        return;
      }
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        usernameSpan.textContent = payload.username || "User";

        // Greeting logic
        const hours = new Date().getHours();
        let greet = "Hello";
        if (hours < 12) greet = "Good Morning 👋";
        else if (hours < 18) greet = "Good Afternoon 👋";
        else greet = "Good Evening 👋";

        greetingText.textContent = greet;
      } catch {
        logout();
      }
    }

    checkAuth();

    // ✅ Show feedback messages
    function showMessage(text, type = "success") {
      messageBox.textContent = text;
      messageBox.style.color = type === "success" ? "green" : "red";
      setTimeout(() => (messageBox.textContent = ""), 3000);
    }

    // ✅ Get today's date in YYYY-MM-DD format
    function getTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ✅ Fetch today's tasks
    async function fetchTodaysTasks() {
      try {
        const res = await fetch(API_URL, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Unauthorized");

        const tasks = await res.json();
        const today = getTodayDate();
        
        // Filter tasks for today
        const todaysTasks = tasks.filter(task => task.dueDate === today);
        
        todayTaskCards.innerHTML = "";

        if (todaysTasks.length === 0) {
          todayTaskCards.innerHTML = '<p class="no-tasks">No tasks for today! 🎉</p>';
          return;
        }

        todaysTasks.forEach((task) => {
          const card = document.createElement("div");
          card.className = `task-card ${task.done ? "done" : ""}`;
          card.innerHTML = `
            <div class="task-header">
              <h3>${task.title}</h3>
              <span class="priority ${task.priority}">${task.priority || "low"}</span>
            </div>
            <p class="task-note">${task.note || ""}</p>
            <div class="task-footer">
              <span class="due-date">📅 Today</span>
              <div class="actions">
                <button class="done-btn" data-id="${task.id}" data-done="${task.done}">
                  ${task.done ? "✅ Done" : "☑️ Mark Done"}
                </button>
                <button class="delete-btn" data-id="${task.id}">🗑️ Delete</button>
              </div>
            </div>
          `;
          todayTaskCards.appendChild(card);
        });

        // Toggle Done
        document.querySelectorAll(".done-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            const currentDone = e.target.dataset.done === "true";

            await fetch(`${API_URL}/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({ done: !currentDone }),
            });

            showMessage(!currentDone ? "Task marked as done ✅" : "Task marked as not done ❌");
            fetchTodaysTasks();
          });
        });

        // Delete Task
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            await fetch(`${API_URL}/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` }
            });
            showMessage("Task deleted 🗑️");
            fetchTodaysTasks();
          });
        });
      } catch (err) {
        showMessage("Error loading tasks ❌", "error");
        if (err.message.includes("Unauthorized")) logout();
      }
    }

    // ✅ Add task with today's date
    document.getElementById("taskForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const messageBox = document.getElementById("formMessage");

      const newTask = {
        title: document.getElementById("title").value,
        dueDate: getTodayDate(), // Set due date to today
        priority: document.getElementById("priority").value,
        note: document.getElementById("note").value,
        done: false,
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(newTask),
        });

        if (!res.ok) throw new Error("Failed to add task");

        messageBox.textContent = "✅ Task added successfully!";
        messageBox.className = "success";
        e.target.reset();
        fetchTodaysTasks();
      } catch (err) {
        messageBox.textContent = "❌ Error adding task. Please try again.";
        messageBox.className = "error";
      }

      setTimeout(() => {
        messageBox.textContent = "";
        messageBox.className = "";
      }, 3000);
    });

    // ✅ Load today's tasks on start
    fetchTodaysTasks();
  </script>
</body>
</html>