<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My To-Do App - Home</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .sidebar {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .sidebar button {
      margin-top: auto;
      background: #d3bdf0;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 6px;
    }
    .greeting {
      font-size: 1.4rem;
      color: #000000;
      margin-bottom: 10px;
    }
    .username-box {
      font-size: 1.5rem;
      color: #444;
      animation: fadeIn 3s ease-in-out infinite alternate;
    }
    @keyframes fadeIn {
      from { opacity: 0.4; }
      to { opacity: 1; }
    }
  </style>
</head>
<body class="home-page">
  <div class="app-container">
    <div class="topbar"><strong>To Do App ‚úçÔ∏è</strong></div>

    <div class="page-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav>
          <ul>
            <li><a href="today.html">Today üè∑Ô∏è</a></li>
            <li><a href="upcoming.html">Upcoming üöÄ</a></li>
            <li><a href="calendar.html">Calendar üóìÔ∏è</a></li>
          </ul>
        </nav>
        <button onclick="logout()">Logout</button>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <div class="greeting" id="greetingText"></div>
          <div class="username-box" id="username"></div>
        </header>

        <!-- Feedback Messages -->
        <div id="message" class="message"></div>

        <!-- Task Form -->
        <section class="task-form">
          <form id="taskForm">
            <input type="text" id="title" placeholder="What do you need to do?" required />
            <input type="date" id="dueDate" title="Due date" />
            <select id="priority">
              <option value="" disabled selected>Choose priority</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
            <textarea id="note" placeholder="Add a note..."></textarea>
            <button type="submit">Add Task</button>
          </form>
          <div id="formMessage"></div>
        </section>

        <!-- Task List -->
        <section class="task-list">
          <h3>Your Tasks</h3>
          <div id="taskCards" class="task-cards"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000/tasks";
    const token = localStorage.getItem("token");
    const messageBox = document.getElementById("message");
    const taskCards = document.getElementById("taskCards");
    const usernameSpan = document.getElementById("username");
    const greetingText = document.getElementById("greetingText");

    // ‚úÖ Logout
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    }

    // ‚úÖ Auth check + Greeting
    async function checkAuth() {
      if (!token) {
        window.location.href = "login.html";
        return;
      }
      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        usernameSpan.textContent = payload.username || "User";

        // Greeting logic
        const hours = new Date().getHours();
        let greet = "Hello";
        if (hours < 12) greet = "Good Morning üëã";
        else if (hours < 18) greet = "Good Afternoon üëã";
        else greet = "Good Evening üëã";

        greetingText.textContent = greet;
      } catch {
        logout();
      }
    }

    checkAuth();

    // ‚úÖ Show feedback messages
    function showMessage(text, type = "success") {
      messageBox.textContent = text;
      messageBox.style.color = type === "success" ? "green" : "red";
      setTimeout(() => (messageBox.textContent = ""), 3000);
    }

    // ‚úÖ Fetch tasks
    async function fetchTasks() {
      try {
        const res = await fetch(API_URL, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Unauthorized");

        const tasks = await res.json();
        taskCards.innerHTML = "";

        tasks.forEach((task) => {
          const card = document.createElement("div");
          card.className = `task-card ${task.done ? "done" : ""}`;
          card.innerHTML = `
            <div class="task-header">
              <h3>${task.title}</h3>
              <span class="priority ${task.priority}">${task.priority || "low"}</span>
            </div>
            <p class="task-note">${task.note || ""}</p>
            <div class="task-footer">
              <span class="due-date">üìÖ ${task.dueDate || "No date"}</span>
              <div class="actions">
                <button class="done-btn" data-id="${task.id}" data-done="${task.done}">
                  ${task.done ? "‚úÖ Done" : "‚òëÔ∏è Mark Done"}
                </button>
                <button class="delete-btn" data-id="${task.id}">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
          taskCards.appendChild(card);
        });

        // Toggle Done
        document.querySelectorAll(".done-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            const currentDone = e.target.dataset.done === "true";

            await fetch(`${API_URL}/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({ done: !currentDone }),
            });

            showMessage(!currentDone ? "Task marked as done ‚úÖ" : "Task marked as not done ‚ùå");
            fetchTasks();
          });
        });

        // Delete Task
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            await fetch(`${API_URL}/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` }
            });
            showMessage("Task deleted üóëÔ∏è");
            fetchTasks();
          });
        });
      } catch (err) {
        showMessage("Error loading tasks ‚ùå", "error");
        if (err.message.includes("Unauthorized")) logout();
      }
    }

    // ‚úÖ Add task
    document.getElementById("taskForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const messageBox = document.getElementById("formMessage");

      const newTask = {
        title: document.getElementById("title").value,
        dueDate: document.getElementById("dueDate").value,
        priority: document.getElementById("priority").value,
        note: document.getElementById("note").value,
        done: false,
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(newTask),
        });

        if (!res.ok) throw new Error("Failed to add task");

        messageBox.textContent = "‚úÖ Task added successfully!";
        messageBox.className = "success";
        e.target.reset();
        fetchTasks();
      } catch (err) {
        messageBox.textContent = "‚ùå Error adding task. Please try again.";
        messageBox.className = "error";
      }

      setTimeout(() => {
        messageBox.textContent = "";
        messageBox.className = "";
      }, 3000);
    });

    // ‚úÖ Load tasks on start
    fetchTasks();
  </script>
</body>
</html>
